# Description

Run openmrs reference application and mysql as disposable docker containers
for demo server.

This OpenMRS docker distribution is built upon a base OpenMRS image. In order to profile OpenMRS running in a docker container, a profiling agent needs to be installed in the container. This distribution adds a JProfiler agent for the profiling of OpenMRS running in a container.

The base docker image used was generated by OpenMRS SDK, and deployed to Docker hub (check <https://hub.docker.com/r/openmrs/openmrs-reference-application-distro/>

## Note: 
1. This ditribution uses the JProfiler version 11.1.4 (<https://download-gcdn.ej-technologies.com/jprofiler/jprofiler_linux_11_1_4.tar.gz>). If you are using a different version, you may need to change the corresponding information in the `Dockerfile` and the `setenv.sh` file.
2. If you need to scale the docker containers of `openmrs-referenceapplication`, in order to avoid port clash, you need to specify a range of host ports instead of just one host port. For example, if you are scaling to less than six containers, you can specify the following host ports:
```
    ports:
      #- "8080:8080"
      - "8080-8085:8080"
      #- "8849:8849"
      - "8849-8854:8849"
```

## Running it locally

To start both containers:
```
$ docker-compose down -v
$ OPENMRS_VERSION=2.5 docker-compose up
```
If you don't add a _OPENMRS_VERSION_ variable, it will use `demo` docker tag.

Note: This last command will build/load two images running in two containers, one for OpenMRS and the other for MySQL. The OpenMRS image (with Jprofler agent) is newly built based on an official iamge, while the MySQL image was direclty loaded from an offical image. If you make changes to the OpenMRS image (e.g., changing the JProfiler agent version), you need to remove the old image and rerun the command `OPENMRS_VERSION=2.5 docker-compose up`.

Application will be eventually accessible on http://localhost:8080/openmrs.
Credentials on shipped demo data:
  - Username: admin
  - Password: Admin123

Use _CTRL + C_ to stop it all containers. But make sure to destroy containers to delete any
left overs volumes and data when doing changes to the docker configuration and images:

```
$ docker-compose down -v
```

## Attach JProfiler GUI to the Docker container JVM
Setup your JProfiler GUI to attach to the JVM running in the Docker container, in the same way as attaching to a remote server. If your JProfiler GUI and the container are running on the same machine, use the localhost IP (127.0.0.1) and port 8849.

## Generate demo data / database from scratch

(If you use the provided demo data in the database, you don't need to run these steps.)

If you want to generate the SQL with the demo data:

  - Comment docker volume `./dbdump` to ignore previous SQL dumps
  - Uncomment docker volume `openmrs-referenceapplication-mysql-data` to allow
  data being persisted between docker runs.
  - Change environment variables _DB_CREATE_TABLES_ and _DB_AUTO_UPDATE_ to true
  to allow OpenMRS to recreate the database schema.
  - Run `docker-compose up` and wait for the application to load
  - Login to OpenMRS and change the global setting
  `referencedemodata.createDemoPatientsOnNextStartup` to 500
  - Run `docker-compose down && docker-compose up` to restart the application.
  This will take quite a while. Wait for the application to load again.
  - Enter the DB docker container (`docker exec -it <container_db_id> bash`)
  - From inside the container, run `mysql --user=openmrs --password=Admin123 openmrs`
  and add the triggers from <https://issues.openmrs.org/browse/ITSM-3917>
  - From inside the container, run:
  `mysqldump --user=openmrs --password=$PASSWORD openmrs > /tmp/dump.sql`
  - From outside the container, copy the dump file to your machine:
  `docker cp <container_db_id>:/tmp/dump.sql .`
  - Due to <https://issues.openmrs.org/browse/SDK-201>, search on the SQL for
   `search.indexVersion` and make it empty.
  - Also, change `atlas.stopAskingToConfigure` to `true` on the SQL file <https://talk.openmrs.org/t/new-demo-server-is-ready-for-tests/9685/12?u=cintiadr>

You'll want to replace the SQL file in dbdump, but no other changes should be committed.
